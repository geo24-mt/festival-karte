<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
		<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
		<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
		<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
		<link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
        <style>
	       html, body {
			    width: 100%; height: 100%; margin: 0;
			    display: flex; flex-direction: column; align-items: center;
			    gap: 60px;
			    background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.8)), 
			                url('background.png') center/cover fixed no-repeat;
		}
			#map {
				width: 65%;
	            height: calc(100% - 100px - 100px);
				border: 2px solid #333;
				box-sizing: border-box;
        }		
			#Überschrift {
				box-sizing: border-box;
				height: 110px;
				width: 100%;
				/* background-clip: padding-box; */
				background: linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db, #2ecc71);
				background-size: 400% 400%;
				animation: holi-flow 10s ease infinite;
				border: 15px double black;
				border-radius:10px;
				display: flex;
				justify-content: center;
				align-items: center;
				overflow: hidden;
				position: sticky;
				top: 0;
				z-index: 1000;
		}	
			@keyframes holi-flow {
				0% { background-position: 0% 50%; }
				50% { background-position: 100% 50%; }
				100% { background-position: 0% 50%; }
		}	
			#Überschrift h1 {
				text-align: center;
				margin: 10px;
				color: white;
				font-family: 'Bangers', system-ui;
				text-shadow: 
				3px 3px 0px #000,
				-1px -1px 0px #000,  
				1px -1px 0px #000,
				-1px 1px 0px #000,
				1px 1px 0px #000;
				letter-spacing: 3px;
				line-height: 1.2;
				z-index: 1;
				font-size: 2.8em;
				transform: rotate(-1deg);
				text-transform: uppercase;
		}	
			.my-tooltip, 
			.landkreis-tooltip, 
			.legende-links, 
			.menu-wrapper {
			    background: 
			        linear-gradient(rgba(30, 30, 30, 0.9), rgba(30, 30, 30, 0.9)) padding-box, 
			        linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db, #2ecc71) border-box;
			    border: 3px solid transparent; 
			    color: #ffffff;
			    font-family: 'Montserrat', sans-serif;
			    box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.5);
		}
			.leaflet-popup-content {
				font-family: 'Montserrat', sans-serif;
				font-size: 13px;
				line-height: 1.4;
		}	
			.leaflet-popup-content th {
				font-weight: 700; 
				text-transform: uppercase; 
				letter-spacing: 0.5px;
				color: #444;
				padding-right: 40px; 
				white-space: nowrap;
				text-align: left;
		}
			.my-tooltip, .landkreis-tooltip {
				border-radius: 10px; 
				padding: 8px 12px;
				font-size: 14px;
				font-weight: bold;
		}
			.menu-wrapper {
			    position: fixed;
			    right: 2.5%; 
			    top: 23%;
			    z-index: 2000;
			    width: 220px;
			    padding: 3px;
			    border-radius: 12px; 
		}
			#filter-menu, #filter-kategorie, .slider-container {
				background-color: rgb(30, 30, 30) !important; 
				color: white;
				border: none;
				border-radius: 9px;
				width: 100%;
				box-sizing: border-box;
		}
			#filter-menu, #filter-kategorie {
				padding: 10px;
				font-family: 'Montserrat', sans-serif;
				font-weight: bold;
				cursor: pointer;
				text-align: center;
    			text-align-last: center; /* Wichtig für Firefox und einige andere Browser */
		}
			.slider-container {
				background-color: rgba(30, 30, 30, 0.95) !important;
				border-radius: 9px;
				padding: 5px;
				display: flex;
				flex-direction: column;
				justify-content: center;
				height: auto; 
				box-sizing: border-box;
				overflow: hidden; 
		}
			
			.slider-label {
				display: block;      /* Damit text-align wirkt */
    			text-align: center;
				color: white;
				font-family: 'Montserrat', sans-serif;
				font-weight: bold;
				font-size: 14px; 
				margin-bottom: 2px;
		}
			#preis-slider {
				-webkit-appearance: none;
				width: 100%;
				height: 5px;
				background: linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db, #2ecc71) !important;
				border-radius: 5px;
				outline: none;
		}
			#preis-slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				height: 16px;
				width: 16px;
				border-radius: 50%;
				background: rgba(210,210,210,1);
				cursor: pointer;
				border: 2px solid #333;
				margin-top: -5.5px; 
		}
			#preis-slider::-moz-range-thumb {
				height: 16px;
				width: 16px;
				border-radius: 50%;
				background: rgba(210,210,210,1);
				border: 2px solid #333;
		}
			.leaflet-tooltip {
				margin-top: -10px;
		}
			.leaflet-popup-content-wrapper {
				background-color: rgba(255, 255, 255, 0.95); 
				border: 4px solid transparent; 
				border-radius: 15px;
				background-image: linear-gradient(rgba(255, 255, 255, 0.98), rgba(245, 245, 245, 0.98)), 
								  linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db, #2ecc71);
				background-origin: border-box;
				background-clip: padding-box, border-box;
				box-shadow: 0 10px 25px rgba(0,0,0,0.2);
				padding: 2px;
		}
			.hide-tooltips .landkreis-tooltip { 
				display: none !important; 
		}
			#reset-button:hover {
				color: #f39c12 !important; 
		}
		
			.flatpickr-calendar.inline {
				background: transparent !important;
				border: none !important;
				box-shadow: none !important;
				transform: scale(1); 
				transform-origin: top center; 
				margin: 0 auto !important;
				width: 100% !important;
		}
			.flatpickr-day {
				height: 28px !important;    
				line-height: 28px !important;
		}	
			flatpickr-innerContainer, .flatpickr-rContainer, .flatpickr-days, .dayContainer {
				width: 100% !important;
				min-width: 100% !important;
				max-width: 100% !important;
		}
			.flatpickr-months {
				height: 35px !important;   
		}
			.flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
				background: #76c7c0 !important;
				border-color: #76c7c0 !important;
				color: #1a1a1a !important; 
				font-weight: bold;
		}
			.flatpickr-day.inRange {
				background: rgba(118, 199, 192, 0.15) !important;
				box-shadow: none !important;
		}
			.legende-links {
			    position: fixed;
			    left: 4%;
			    top: 58%;
			    transform: translateY(-50%);
			    padding: 20px;
			    border-radius: 12px;
			    display: flex;
			    flex-direction: column;
			    gap: 15px;
		}
			.legende-item {
			    display: flex;
			    align-items: center;
			    gap: 15px;
			    font-size: 14px;
		}
			.icon-wrapper {
			    width: 48px;  
			    height: 48px;
			    display: flex;
			    align-items: center;
			    justify-content: center;
			    flex-shrink: 0;
		}
			.icon-wrapper img {
			    width: 44px;  
			    height: 44px;
			    object-fit: contain;
		}   
			.festival-icon-style {
			    object-fit: contain; 
			    border: none !important; 
			    background: transparent !important;
		}
			.leaflet-control-zoom.leaflet-bar, 
			.leaflet-control-locate.leaflet-bar {
			    background: linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db, #2ecc71) !important;
			    padding: 2px !important;
			    border-radius: 12px !important;
			    border: none !important;
			    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
		}
			.leaflet-control-zoom.leaflet-bar a,
			.leaflet-control-locate.leaflet-bar a {
			    background-color: white !important; 
			    border-radius: 10px !important;
			    border: none !important;
			    margin: 1px !important;
				overflow: hidden !important;
		}
			/* Den Container lassen wir so, wie du ihn hast */
.multiselect-container {
    position: relative;
    /* Wir nutzen das Design deiner anderen Wrapper */
    background: transparent !important; 
    color: white;
    width: 100%;
}

/* HIER liegt der Fehler bei der Größe: Der Header braucht eine Mindesthöhe */
.select-box-header {
    padding: 10px;
    min-height: 40px; /* Erzwingt die gleiche Höhe wie bei den anderen Filtern */
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgb(30, 30, 30); /* Gleiches Schwarz wie die anderen */
    border-radius: 9px;
    font-family: 'Montserrat', sans-serif;
    font-weight: bold;
    box-sizing: border-box;
    cursor: pointer;
}

/* HIER liegt der Fehler beim Öffnen: Die Liste muss über allem schweben */
.checkbox-content {
    display: none; /* Standardmäßig zu */
    position: absolute; /* WICHTIG: Schwebt über der Karte */
    top: 105%; /* Kleiner Abstand zum Header */
    left: 0;
    background-color: rgb(30, 30, 30);
    width: 100%;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
    z-index: 5000; /* Sehr hoch, damit es über dem Kalender erscheint */
    max-height: 200px;
    overflow-y: auto;
    border: 2px solid #444;
    border-radius: 9px;
    box-sizing: border-box;
}

.checkbox-item {
    display: flex; /* Flex macht das Ausrichten von Checkbox und Text leichter */
    align-items: center;
    padding: 10px;
    text-align: left;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
}

.checkbox-item input {
    margin-right: 10px; /* Abstand zwischen Haken und Text */
}

.checkbox-item:hover {
    background-color: #444;
}
			
/* --- RESPONSIVE OPTIMIERUNG FÜR HANDYS --- */
	@media (max-width: 768px) {
	   html, body {
	        height: auto !important; 
	        min-height: 100vh; 
	        overflow-y: auto !important;
	        overflow-x: hidden;
	        gap: 20px;
	        display: flex;
	        flex-direction: column;
	    }
	    #map {
	        width: 95%;
	        height: 400px; 
	        order: 2;      
	    }
	    #Überschrift {
	        height: auto;
	        padding: 10px 0;
	        order: 1;     
	    }
	    #Überschrift h1 {
	        font-size: 1.5em;
	    }
	    .legende-links {
	        position: relative; 
	        left: 0;
	        top: 0;
	        transform: none;
	        width: 95%;
	        box-sizing: border-box;
	        order: 1;          
	        flex-direction: row;
	        flex-wrap: wrap;   
	        justify-content: center;
	        gap: 10px;
	        padding: 10px;
	    }
	    .legende-item {
	        font-size: 11px;
	        gap: 5px;
	    }
	    .icon-wrapper {
	        width: 32px;
	        height: 32px;
	    }
	    .icon-wrapper img {
	        width: 24px;
	        height: 24px;
	    }
	    .menu-wrapper {
	        position: relative; 
	        right: 0;
	        top: 0;
	        width: 95%;
	        margin: 0 auto;
	        box-sizing: border-box;
	        order: 3;          
	    }
	    .slider-container {
	        padding: 10px;
	    }
	    .menu-wrapper {
	        top: auto !important; 
	        margin-bottom: 10px;  
	        display: flex;
	        flex-direction: column;
	    }
	    .menu-wrapper:has(#event-kalender) {
	        order: 4; 
	    }
	    .menu-wrapper:has(#reset-button) {
	        order: 5; 
	    }}
			
  </style>
        <title></title>
    </head>
    <body>
        <div id="Überschrift">
		<h1>Die Bunte Welt der Festivals</h1>
		</div>
		<div class="menu-wrapper">
    <div id="filter-menu" class="multiselect-container">
        <div class="select-box-header" onclick="toggleCheckboxes()">
            <span id="selected-text">- Landkreise wählen -</span>
            <span style="float: right;">▼</span>
        </div>
        <div id="checkbox-list" class="checkbox-content">
            <label class="checkbox-item">
                <input type="checkbox" id="all-kreise" onchange="toggleAllKreise(this)" checked> 
                <strong>- Alle Landkreise -</strong>
            </label>
            <hr style="border: 0.5px solid #444; margin: 5px 0;">
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="Merzig-Wadern" onchange="filterKarte()" checked> Merzig-Wadern</label>
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="Neunkirchen" onchange="filterKarte()" checked> Neunkirchen</label>
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="Regionalverband Saarbrücken" onchange="filterKarte()" checked> Saarbrücken</label>
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="Saarlouis" onchange="filterKarte()" checked> Saarlouis</label>
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="Saarpfalz-Kreis" onchange="filterKarte()" checked> Saarpfalz-Kreis</label>
            <label class="checkbox-item"><input type="checkbox" class="kreis-check" value="St. Wendel" onchange="filterKarte()" checked> St. Wendel</label>
        </div>
    </div>
</div>
		<div class="menu-wrapper" style="top: 32%;">
			<select id="filter-kategorie" onchange="filterKarte()">
				<option value="alle">- Alle Festival-Kategorien -</option>
				<option value="Electro Festivals">Electro Festivals</option>
				<option value="Mittelalter Festivals">Mittelalter Festivals</option>
				<option value="Punk Festivals">Punk Festivals</option>
				<option value="Schlager Festivals">Schlager Festivals</option>
			</select>
		</div>
		<div class="menu-wrapper" style="top: 41%;">
			<div class="slider-container">
				<label for="preis-slider" class="slider-label">
					- Max. Preis: <span id="preis-wert">300</span> € -
				</label>
				<input type="range" id="preis-slider" 
					   min="0" max="300" step="10" value="300" 
					   oninput="filterKarte()">	   
			</div>
		</div>	
		<div class="menu-wrapper" style="top: 88%;">
			<button id="reset-button" onclick="resetFilter()" style="
				background-color: rgb(30, 30, 30); 
				color: white; 
				border: none; 
				border-radius: 9px; 
				width: 100%; 
				height: 40px; 
				font-family: 'Montserrat', sans-serif; 
				font-weight: bold; 
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				outline: none;">
				Filter zurücksetzen
			</button>
		</div>
	<div class="menu-wrapper" style="top: 50%;">
	    <div class="slider-container" 
	         title="Tipp:&#10;Wähle Start- & Enddatum für Zeitraum.&#10;Für Einzeltag das Datum 2x anklicken" 
	         style="height: auto; padding: 10px 5px 5px 5px; background-color: rgb(30, 30, 30) !important;">
	        <input type="text" id="event-kalender" style="display: none;">
	    </div>
	</div>
		<div class="legende-links">
    <div class="legende-item">
        <div class="icon-wrapper">
            <img src="Symbole/Electro_symbol.png">
        </div>
        <span>Electro</span>
    </div>
    <div class="legende-item">
        <div class="icon-wrapper">
            <img src="Symbole/Mittelalter-Festival_schwarz_weiss_symbol.png">
        </div>
        <span>Mittelalter</span>
    </div>
    <div class="legende-item">
        <div class="icon-wrapper">
            <img src="Symbole/Punk_symbol.png">
        </div>
        <span>Punk</span>
    </div>
    <div class="legende-item">
        <div class="icon-wrapper">
            <img src="Symbole/Schlager_symbol.png">
        </div>
        <span>Schlager</span>
    </div>
</div>
		<div id="map"></div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
      <!--  <script src="js/L.Control.Layers.Tree.min.js"></script> -->
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/multi-style-layer.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/Kreise_1.js"></script>
        <script src="data/Festivals_kreis_2.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;
            highlightLayer.openPopup();
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:7
        }).fitBounds([[48.95633153790181,6.124602242155099],[49.74555999436068,7.660429008508997]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');}}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
			localization: 'de'
        });
        measureControl.addTo(map);
			
        var mE = document.getElementsByClassName('leaflet-control-measure')[0];
        var mT = document.getElementsByClassName('leaflet-control-measure-toggle')[0];
        if (mE) { mE.style.borderRadius = '12px'; mE.style.overflow = 'hidden'; }
        if (mT) { mT.style.borderRadius = '10px'; mT.style.overflow = 'hidden'; }
        
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_GoogleMaps_0');
        map.getPane('pane_GoogleMaps_0').style.zIndex = 400;
        var layer_GoogleMaps_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=m&hl=de&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMaps_0',
            opacity: 1.0,
            attribution: '© Google Maps',
            minZoom: 3,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 22
        });
        layer_GoogleMaps_0;
        map.addLayer(layer_GoogleMaps_0);
        function pop_Kreise_1(feature, layer) {
    // Tooltip einbinden
    if (feature.properties['gen'] !== null) {
        layer.bindTooltip(String(feature.properties['gen']), {
            sticky: true,
            className: 'landkreis-tooltip',
            direction: 'auto',
            offset: [15, 10]
        });
    }
    layer.on('add', function (e) {
        e.target.getElement().style.cursor = 'default';
    });
}
       function style_Kreise_1_0(feature) {
    return {
        pane: 'pane_Kreise_1',
        opacity: 1,
        color: 'rgba(110, 110, 110, 1)', 
        weight: 1.8,
        fill: true,
        fillOpacity: 0, 
        fillColor: 'rgba(100, 100, 100, 1.0)', 
        interactive: true,
    };
}
        map.createPane('pane_Kreise_1');
        map.getPane('pane_Kreise_1').style.zIndex = 401;
        map.getPane('pane_Kreise_1').style['mix-blend-mode'] = 'normal';
        var layer_Kreise_1 = new L.geoJson(json_Kreise_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Kreise_1',
            layerName: 'layer_Kreise_1',
            pane: 'pane_Kreise_1',
            onEachFeature: pop_Kreise_1,
            style: style_Kreise_1_0,
        });
        bounds_group.addLayer(layer_Kreise_1);
        map.addLayer(layer_Kreise_1);
		function getFestivalIcon(kategorie) {
	    var fileName;
	    switch(kategorie) {
	        case 'Electro Festivals':      fileName = 'Electro_symbol.png'; break;
	        case 'Mittelalter Festivals': fileName = 'Mittelalter-Festival_schwarz_weiss_symbol.png'; break;
	        case 'Punk Festivals':         fileName = 'Punk_symbol.png'; break;
	        case 'Schlager Festivals':     fileName = 'Schlager_symbol.png'; break;
	        default:                       fileName = 'default.png'; 
	    }
	    var isMobile = window.innerWidth <= 768;
    var iconSize   = isMobile ? [28, 28] : [44, 44]; 
    var iconAnchor = isMobile ? [14, 14] : [22, 22]; 

    return L.icon({
        iconUrl: 'Symbole/' + fileName,
        iconSize: iconSize, 
        iconAnchor: iconAnchor,
        className: 'festival-icon-style' 
    });
}
	function pop_Festivals_kreis_2(feature, layer) {
    if (feature.properties['Festival_N']) {
        layer.bindTooltip(String(feature.properties['Festival_N']), {
            sticky: true,
            className: 'my-tooltip'
        });
    }
    var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Festival-Name</th>\
                        <td class="visible-with-data">' + (feature.properties['Festival_N'] || '') + '</td>\
                    </tr>\
                    <tr style="height: 10px;"> <td colspan="2"></td> </tr>\
                    <tr>\
                        <th scope="row">Kategorie</th>\
                        <td class="visible-with-data">' + (feature.properties['Kategorie'] || '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Genre</th>\
                        <td class="visible-with-data">' + (feature.properties['Genre'] || '') + '</td>\
                    </tr>\
                    <tr style="height: 10px;"> <td colspan="2"></td> </tr>\
                    <tr>\
                        <th scope="row">Preise ab</th>\
                        <td class="visible-with-data">' + (feature.properties['Preise ab'] !== null ? parseFloat(feature.properties['Preise ab']).toFixed(2).replace('.', ',') + ' €' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Datum</th>\
                        <td class="visible-with-data">' + (feature.properties['Datum'] !== null ? String(feature.properties['Datum']) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Dauer</th>\
                        <td class="visible-with-data">' + (feature.properties['Dauer'] || '') + '</td>\
                    </tr>\
                    <tr style="height: 10px;"> <td colspan="2"></td> </tr>\
                    <tr>\
                        <th scope="row">Straße</th>\
                        <td class="visible-with-data">' + (feature.properties['Straße'] || '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">PLZ</th>\
                        <td class="visible-with-data">' + (feature.properties['PLZ'] || '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Ort</th>\
                        <td class="visible-with-data">' + (feature.properties['Ort'] || '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Landkreis</th>\
                        <td class="visible-with-data">' + (feature.properties['gen'] || '') + '</td>\
                    </tr>\
                </table>';
    layer.bindPopup(popupContent, {
        minWidth: 350,
        maxWidth: 800,
        autoPan: true
    });
}
      
        map.createPane('pane_Festivals_kreis_2');
        map.getPane('pane_Festivals_kreis_2').style.zIndex = 402;
        map.getPane('pane_Festivals_kreis_2').style['mix-blend-mode'] = 'normal';
        var layer_Festivals_kreis_2 = new L.geoJson.multiStyle(json_Festivals_kreis_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Festivals_kreis_2',
            layerName: 'layer_Festivals_kreis_2',
            pane: 'pane_Festivals_kreis_2',
            onEachFeature: pop_Festivals_kreis_2,
            pointToLayers: [function (feature, latlng) { 
                var kat = String(feature.properties['Kategorie']);
                return L.marker(latlng, {
                    icon: getFestivalIcon(kat),
                    interactive: true
                });
            }] 
        }); 
        bounds_group.addLayer(layer_Festivals_kreis_2);
        map.addLayer(layer_Festivals_kreis_2);
    map.on("zoomend", function(e) {
    var zoom = map.getZoom();
    var minZoom = (window.innerWidth <= 768) ? 7 : 9;
    if (zoom <= 19 && zoom >= minZoom) {
        if (!map.hasLayer(layer_Festivals_kreis_2)) {
            map.addLayer(layer_Festivals_kreis_2);
        }
    } else {
        if (map.hasLayer(layer_Festivals_kreis_2)) {
            map.removeLayer(layer_Festivals_kreis_2);
        }
    }
});
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
            // resultsHandler: myHandler,
        }).addTo(map);
        var x = null;
        var marker = null;
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
       

        // Create the new button element
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        // Insert the button at the beginning of the search control
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });
        setBounds();
        map.addControl(new L.Control.Search({
            layer: layer_Festivals_kreis_2,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Genre'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }
		function setBounds() {
        }
        map.on("zoomend", function() {
            if (map.getZoom() > 11) {
                document.getElementById('map').classList.add('hide-tooltips');
            } else {
                document.getElementById('map').classList.remove('hide-tooltips');
            }
        });
function filterKarte() {
    // NEU: Holt alle Werte der Checkboxen, die einen Haken haben
    var gewaehlteKreise = Array.from(document.querySelectorAll('.kreis-check:checked')).map(cb => cb.value);
    
    // NEU: Prüft, ob die "Alle Landkreise"-Checkbox gehakt ist
    var alleKreiseAktiv = document.getElementById('all-kreise').checked;
    
    var gewaehlteKat = document.getElementById('filter-kategorie').value;
    var gewaehlterPreis = parseFloat(document.getElementById('preis-slider').value);

    var gewaehlteDaten = festivalKalender.selectedDates;
    var startFilter = null;
    var endFilter = null;

    if (gewaehlteDaten.length > 0) {
        startFilter = gewaehlteDaten[0];
        endFilter = gewaehlteDaten[1] ? gewaehlteDaten[1] : startFilter;
    }

    var wertAnzeige = document.getElementById('preis-wert');
    if (wertAnzeige) wertAnzeige.innerText = gewaehlterPreis;

    var parseDate = function(str) {
        if(!str) return null;
        var d = str.trim().split('.');
        var tag = parseInt(d[0]);
        var monat = parseInt(d[1]) - 1;
        var jahr = d[2] ? parseInt(d[2]) : 2026;
        return new Date(jahr, monat, tag);
    };

    // 2. Kreise/Landkreise auf der Karte filtern
    layer_Kreise_1.eachLayer(function(layer) {
        var name = String(layer.feature.properties['gen']);
        if (alleKreiseAktiv || gewaehlteKreise.includes(name)) {
            layer.setStyle({opacity: 1, weight: 1.2, interactive: true});
        } else {
            layer.setStyle({opacity: 0, weight: 0, interactive: false});
        }
    });

    // 3. Festivals filtern
    layer_Festivals_kreis_2.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties) {
            var props = layer.feature.properties;
            var fKreis = String(props['gen']); 
            var fKat = String(props['Kategorie']);
            var fPreis = parseFloat(props['Preise ab']);
            var fDatumRaw = String(props['Datum']); 
            var datumCheck = true; 
            if (startFilter && endFilter) {
                var teile = fDatumRaw.split(/[-–]| bis /);
                var festivalStart = parseDate(teile[0]);
                var festivalEnd = teile[1] ? parseDate(teile[1]) : festivalStart;
                datumCheck = (festivalStart <= endFilter && festivalEnd >= startFilter);
            }
            var kreisCheck = (alleKreiseAktiv || gewaehlteKreise.includes(fKreis));
            var katCheck = (gewaehlteKat === "alle" || fKat === gewaehlteKat);
            var preisCheck = (isNaN(fPreis) || fPreis === null || fPreis <= gewaehlterPreis);

            if (layer.getElement()) {
                if (kreisCheck && katCheck && preisCheck && datumCheck) {
                    layer.getElement().style.display = 'block';
                } else {
                    layer.getElement().style.display = 'none';
                }
            }
        }
    });
}
		function resetFilter() {
    // 1. Alle Kreis-Checkboxen wieder auf "checked" setzen
    document.getElementById('all-kreise').checked = true;
    var kreisChecks = document.querySelectorAll('.kreis-check');
    kreisChecks.forEach(cb => cb.checked = true);

    // 2. Restliche Filter zurücksetzen
    document.getElementById('filter-kategorie').value = 'alle';
    document.getElementById('preis-slider').value = 300; // Falls dein Max 300 ist
    
    var preisAnzeige = document.getElementById('preis-wert');
    if (preisAnzeige) preisAnzeige.innerText = '300';
    
    if (festivalKalender) {
        festivalKalender.clear();
        festivalKalender.jumpToDate(new Date());
    }
    
    filterKarte();
}
		let festivalKalender;
			document.addEventListener("DOMContentLoaded", function() {
				const deCfg = {
					weekdays: {
						shorthand: ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
						longhand: ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"]
					},
					months: {
						shorthand: ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"],
						longhand: ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]
					},
					rangeSeparator: " bis ",
					firstDayOfWeek: 1 
				};
				festivalKalender = flatpickr("#event-kalender", {
				    mode: "range",
				    inline: true,
				    static: true,
				    locale: deCfg, 
				    dateFormat: "d.m.Y",
				    theme: "dark",
				    monthSelectorType: "static",
				    // NEU: Diese Zeile erlaubt es, dass die Auswahl nach dem ersten Klick nicht "gesperrt" ist
				    closeOnSelect: false, 
					
				    onChange: function(selectedDates, dateStr, instance) {
				        // Wir filtern immer, egal ob 1 oder 2 Daten gewählt sind
				        if (selectedDates.length > 0) {
				            filterKarte();
				        }
				    }
				});
							});
			function toggleCheckboxes() {
    var list = document.getElementById("checkbox-list");
    if (list.style.display === "block") {
        list.style.display = "none";
    } else {
        list.style.display = "block";
    }
}
       </script>
    </body>
</html>
